\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath, amsthm, amsfonts, amssymb}
\usepackage{mathtools}
\usepackage{tikz-cd}
\usepackage{enumerate}
\usepackage[hidelinks, unicode]{hyperref}
\usepackage{cleveref}
\usepackage[style=alphabetic]{biblatex}

\addbibresource{bibliography.bib}

\theoremstyle{plain}% default
\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}{Lemma}[section]
\newtheorem{proposition}{Proposition}[section]
\newtheorem{remark}{Remark}[section]
\newtheorem{corollary}{Corollary}[section]

\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]
\newtheorem{conjecture}{Conjecture}[section]
\newtheorem{example}{Example}[section]

\theoremstyle{remark}
\newtheorem*{note}{Note}
\newtheorem{case}{Case}
\newtheorem*{notation}{Notation}



\newcommand{\cob}{\mathcal{C}_\mathcal{O}^\bullet}
\newcommand{\co}{\mathcal{C}_\mathcal{O}}
\newcommand{\ann}{\operatorname{Ann}}
\newcommand{\im}{\operatorname{im}}
\newcommand{\fitt}{\operatorname{Fitt}}
\renewcommand{\hom}{\operatorname{Hom}}

\title{Wiles' numerical criterion}
\author{Josua Kugler}

\begin{document}
\maketitle
\tableofcontents

\newpage
\section{Introduction}
Wiles has discovered a criterion for two rings in a specific category to be isomorphic 
that only depends on some numerical invariants of these rings. 
The aim of this section is to prove that criterion in its purely algebraic form. 
%TODO: Explain how this fits into the rest of the proof.
In our presentation, we closely follow \cite[5.1 - 5.8]{darmon1995fermat}.

\section{Preliminaries and examples}
Let \(\mathcal{O}\) be the ring of integers of a finite extension \(K\) of \(\mathbb Q_\ell\). 
As \(K\) is a local field, its ring of integers is a discrete valutation ring (DVR), i.e. 
\(\mathcal O\) is a local, noetherian Dedekind ring with maximal ideal \(\lambda\). 
It is complete with resp server usedect to the \(\lambda\)-adic topology, a principal ideal domain (PID) 
and has residue field \(k \coloneqq \mathcal{O}/\lambda\) 
to name some properties that we will use in the course of the proof.

\(\mathbb Z_\ell\) is the ring of integers of \(\mathbb Q_\ell\) and 
\(\mathbb F_\ell = \mathbb Z_\ell/\ell \mathbb Z_\ell\) its residue field. 
As \(K/\mathbb{Q}_\ell\) is finite, the residue field of \(\mathcal{O}\) 
is a finite extension of $\mathbb F_\ell$ and therefore finite. 
%Not entirely clear to me

\paragraph{The categories \(\co\) and \(\cob\)}
In this section, we will mostly deal with very specific rings. 
Therefore we define the category \(\co\) where objects of \(\co\) are local complete noetherian \(\mathcal O\)-algebras 
with residue field \(k\) and the morphisms are local \(\mathcal{O}\)-algebra morphisms.
Often, we even need some extra structure. 
We obtain the category \(\cob\) from \(\co\) by equipping an object \(A\) 
with an additional surjective \(\mathcal{O}\)-algebra homomorphism
\[\pi_A \colon A \twoheadrightarrow \mathcal{O},\]
the so-called augmentation map. Objects in \(\cob\) are often called \textit{augmented rings}.
The morphisms in \(\cob\) are local \(\mathcal{O}\)-algebra morphisms that respect the augmentation map structure, 
i.e. for a morphism \(f \colon A \to B\) we have the commutative diagram
\[
\begin{tikzcd}[column sep=small]
    A \arrow[rr, "f"] \arrow [dr, "\pi_A", swap, twoheadrightarrow] & & B \arrow [dl, "\pi_B", twoheadrightarrow]\\
    & \mathcal{O} &
\end{tikzcd}.
\]

In order to state Wiles' criterion, we need some more definitions.
\begin{definition}
    \(A \in \co\) is \textit{finite flat}, if \(A\) is finitely generated 
    and torsion-free as an \(\mathcal{O}\)-module.
    Note that \(\mathcal{O}\) is a PID and therefore being torsion-free 
    is equivalent to being flat as an \(\mathcal{O}\)-module.
\end{definition}

\begin{definition}[complete intersection]\cite[see][Def. 5.1]{darmon1995fermat}
    A finite flat ring \(A \in \co\) is called a \textit{complete intersection}, 
    if \(A\) is isomorphic as an \(\mathcal{O}\)-algebra to a quotient
    \[A \cong \mathcal{O}[[X_1, \dots, X_n]]/(f_1, \dots, f_n),\] 
    where there are as many relations as there are variables.
    %Why is this a good definition? Where does the name come from? see probably remark 5.2
\end{definition}

Let's take a look at an example.
\begin{example}\label{ex:first_1}\cite[cf.][example 1]{darmon1995fermat}
    \(A = \{(a,b) \in \mathcal{O}\times\mathcal{O},\; a \equiv b\; (\operatorname{mod} \lambda^n)\} 
    \cong \mathcal{O}[[T]]/(T(T-\lambda^n))\) is a finite flat complete intersection in \(\cob\).
    The projection \(\pi_A\) is given by \(\pi_A(a,b) = a\).
    \begin{proof}
        Consider the map
        \begin{align*}
            \phi\colon \mathcal{O}[[T]]/(T(T-\lambda^n)) &\to A\\
            f &\mapsto (f(0), f(\lambda^n)).
        \end{align*}
        \subparagraph*{\(\phi\) is welldefined and respects the \(\mathcal{O}\)-algebra structure:}
        Let \(f_0\) be the constant term of a polynomial \(f\) and \(f_1 \coloneqq T^{-1}(f-f_0)\), 
        s.t. \(f = f_0 + T\cdot f_1(T)\). Because of
        \[
            f(0) - f(\lambda^n) 
            = (f_0 + 0\cdot f_1(0)) - (f_0 + \lambda^n \cdot f_1(\lambda^n)) 
            = -\lambda^n \cdot f_1(\lambda^n),
        \]
        \(f(0) \equiv f(\lambda^n)\; (\operatorname{mod} \lambda^n)\) as required.
        Furthermore, \[\phi(T(T-\lambda^n)) = (0(-\lambda^n), \lambda^n(\lambda^n - \lambda^n)) = (0,0).\]
        Finally, we need to think about series in \(\mathcal{O}[[T]]\) with infinitely many terms.
        For the first component \(f(0)\) this doesn't matter, as \(\phi\) just takes the constant term. 
        As \(\mathcal{O}\) is complete with respect to the \(\lambda\)-adic topology, 
        the map \(\tilde\phi_2\colon \mathcal{O}[[T]] \to \mathcal{O},\; f \mapsto f(\lambda^n)\) 
        is clearly welldefined and thus \(\phi\) is welldefined.
        %O-algebra structure:
        Let \(o \in \mathcal{O}\). Then 
        \[\phi(of) = ((of)(0),(of)(\lambda^n)) = (of(0), of(\lambda^n)) = o(f(0), f(\lambda^n)) = o\phi(f)\]
        \subparagraph*{Injectivity:}
        Let \(\phi(f) = 0\). Then \(f(0) = 0 \implies T | f\) and \(f(\lambda^n) = 0 \implies (T - \lambda) | f\).
        As a result, \(f \in T(T-\lambda)\).
        \subparagraph{Surjectivity:}
        Let \((a,b) \in A\).
        As \(a \equiv b \operatorname{mod} \lambda^n,\) we can write \(b = a + b' \cdot \lambda^n\). Because of
        \[\phi(\overline{a + b'T}) = (a, a + b' \lambda^n) = (a,b),\] \(\phi\) is surjective.
        \subparagraph*{\(A\in \cob\):}
        \(\mathcal{O}\) is noetherian, so \(\mathcal{O}[T]/(T(T-\lambda^n))\) is noetherian as well.
        \((\lambda, T)\) is a maximal ideal in \(\mathcal{O}[T]/(T(T-\lambda^n))\), because
        \[\left(\mathcal{O}[T]/(T(T-\lambda^n))\right)/(\lambda, T) = \mathcal{O}/(\lambda) = k.\]
        %Korollar 24.13 Alg II
        Therefore, the completion \(\mathcal{O}[T]/(T(T-\lambda^n))^{\wedge(\lambda, T)}\) 
        of \(\mathcal{O}[T]/(T(T-\lambda^n))\) with respect to \((\lambda, T)\) is a local ring with maximal ideal
        \(\widehat{(\lambda, T)}\).
        Consider the SES of finitely generated \(\mathcal{O}\)-modules
        \[
            0 \to (T(T - \lambda^n)) \mathcal{O}[T] \to \mathcal{O}[T] \to \mathcal{O}[T]/(T(T-\lambda^n)) \to 0.
        \]
        %Theorem 24.9
        As completion of finitely generated \(\mathcal{O}\)-modules is exact (because \(\mathcal{O}\) is noetherian), we get the SES
        \[
            0 \to (T(T-\lambda^n))\mathcal{O}[[T]] \to \mathcal{O}[[T]] \to \mathcal{O}[T]/(T(T-\lambda^n))^{\wedge (\lambda, T)}  \to 0.
        \]
        by completing with respect to \((\lambda, T)\).
        As a result, we have
        \[
            \mathcal{O}[T]/(T(T-\lambda^n))^{\wedge (\lambda, T)} = \mathcal{O}[[T]]/(T(T-\lambda^n)).
        \]
        As a result, \(\mathcal{O}[[T]]/(T(T-\lambda^n))\) is a local ring with maximal ideal \((\lambda, T)\).
        Therefore, its residue field is
        \[
            \mathcal{O}[[T]]/(T(T-\lambda^n))/(\lambda, T) = \mathcal{O}[T]/(T(T-\lambda^n))/(\lambda, T) = \mathcal{O}/(\lambda) = k.
        \]
        %Theorem 10.26 in Atiyah-MacDonald
        As \(\mathcal{O}[T]/(T(T-\lambda^n))\) is noetherian, its \((\lambda, T)\)-completion \(\mathcal{O}[[T]]/(T(T-\lambda^n))\)
        is again noetherian \cite[cf.][theorem 10.26]{Atiyah1969}.

        In total, we get that \(A \cong \mathcal{O}[[T]]/(T(T-\lambda^n))\) is a local, complete, noetherian \(\mathcal{O}\)-algebra 
        with residue field \(k\; \implies A \in \co\). 
        \subparagraph{\(A\) is a finite flat complete intersection:}
        \(A\) is generated by \((1,1)\) and \(0, \lambda^n\) because
        \[
            (a,b) = a(1,1) + (0, \underbrace{b-a}_{\in \lambda^n}) = a(1,1) + c(0, \lambda^n).
        \]
        Also, \(A\) is torsion-free because \(\mathcal{O}\) is an integral domain. 
        As there is one variable and one relation in \(A \cong \mathcal{O}[[T]]/(T(T-\lambda^n))\), \(A\) is a complete intersection.
    \end{proof}
\end{example}

%probably add more examples

\begin{example}\label{ex:last_1}\cite[cf.][example 5]{darmon1995fermat}
    \(U = \mathcal{O}[[X_1, \dots, X_n]]\) with projection \(\pi_U\colon U \to \mathcal{O},\; f \mapsto f(0)\) lies in \(\cob\).
    \begin{proof}
        \(\mathcal{O}\) is noetherian, so \(\mathcal{O}[X_1, \dots, X_{n}]\) is noetherian as well.
        \((\lambda, X_1, \dots, X_n)\) is a maximal ideal in \(\mathcal{O}[X_1, \dots, X_n]\), because
        \[\left(\mathcal{O}[X_1, \dots, X_n]\right)/(\lambda, X_1, \dots, X_n) = \mathcal{O}/(\lambda) = k.\]
        %Korollar 24.13 Alg II
        Therefore, the completion \[\mathcal{O}[X_1, \dots, X_n]^{\wedge(\lambda, X_1, \dots, X_n)} = \mathcal{O}[[X_1, \dots, X_n]]\]
        of \(\mathcal{O}[X_1, \dots, X_n]\) with respect to \((\lambda, X_1, \dots, X_n)\) is a local ring with maximal ideal
        \(\widehat{(\lambda, X_1, \dots, X_n)}\).
        Its residue field is \(\mathcal{O}[X_1, \dots, X_n]/(\lambda, X_1, \dots, X_n) = k\), as required.
        As \(\mathcal{O}[X_1, \dots, X_n]\) is noetherian, its \((\lambda, X_1, \dots, X_n)\)-completion is again noetherian.
    \end{proof}
\end{example}

\begin{remark}\label{rem:quotientofU}
    In \cref{ex:first_1} we could write \(A\) as a quotient of \(\mathcal{O}[[X]]\). 
    This is possible in a more general setting, in fact every \(A \in \co\) can be written as a quotient of
    \(U = \mathcal{O}[[X_1, \dots, X_n]]\) for suitable \(n\).
\end{remark}
\begin{proof}
    As \(A\) is a noetherian ring and \(\ker \pi_A\) is an ideal in \(A\), it is finitely generated 
    and therefore also finitely generated as an \(A\)-module. Consider the map
    \begin{align*}
        \Phi\colon U = \mathcal{O}[[X_1, \dots, X_n]] &\to A\\
        X_i &\mapsto a_i,
    \end{align*}
    where \(\ker \pi_A = (a_1, \dots, a_n)\) and \(\pi_U\) is given by \(f \mapsto f(0)\). 
    As \((X_1, \dots, X_n)\) generate the kernel of \(\pi_U\), this is a map in \(\cob\).
    We have the short exact sequences
    \[
        0 \to \ker \pi_A \to A \to \im \pi_A \cong \mathcal{O} \to 0
    \]
    and
    \[
        0 \to \ker \pi_U \to U \to \im \pi_U \cong \mathcal{O} \to 0
    \]
    As both corresponding sequences split via the inclusion \(\mathcal{O} \hookrightarrow A, x \mapsto x \cdot 1\)
    resp. \(\mathcal{O} \hookrightarrow U\), we can write \(A \cong \mathcal{O} \oplus \ker \pi_A\) 
    and \(A[[X_1, \dots, X_n]] \cong A \oplus \ker \pi_A\).
    \(\Phi\) by definition induces an equality on the first component, 
    a surjection on the second and therefore is surjective on the direct sum.
\end{proof}

\begin{definition}
    Let \(A \in \cob\). Then
    \[\phi_A \coloneqq (\ker \pi_A)/(\ker \pi_A)^2.\]
    %is the following helpful?
    The reader with background in algebraic geometry might notice that this can be thought of as a tangent space, 
    in particular it is the cotangent space of the scheme \(\operatorname{spec}(A)\) at the point \(\ker \pi_A\).
    However this point of view is not necessary in the following, 
    it might be more a hint of how Wiles came to investigate this specific invariant.
\end{definition}

\begin{example}\label{ex:last_phi}
    Remember the definition of \(U\) in \cref{ex:last_1}.
    The tangent space \(\phi_U = \ker \pi_U/(\ker \pi_U)^2\) is
    \[
        \mathcal{O}X_1 \oplus \dots \oplus \mathcal{O}X_n.
    \]
    Indeed, elements of \(f \in \ker \pi_U\) have no constant term as \(f(0) = 0\) and therefore are multiples of \(X\).
    Elements in \(\ker \pi_U^2\) are multiples of \(X^2\). As a result, we receive elements \(\overline{f} \in \phi_U\) by
    cutting of all higher terms of a power series \(f \in \ker \pi_U\).
\end{example}

\begin{remark}\label{rem:tangentspace}
    Write \(A\) as a quotient of \(U,\; A = U/(f_1, \dots, f_m)\). 
    This is possible because of \cref{rem:quotientofU}.
    We then get \(\phi_A = \phi_U/(\overline{f_1}, \dots, \overline{f_m})\).
    As a quotient of \(\phi_U\) its a finitely generated \(\mathcal{O}\)-module.
\end{remark}
\begin{proof}
    Consider the following map of \(\mathcal{O}\)-modules
    %\begin{align*}
    %    \Phi\colon \ker \pi_U = \mathcal{O}X_1 \oplus \dots \oplus \mathcal{O}X_n &\to (\ker \pi_A)/(\ker \pi_A)^2 = \phi_A\\
    %    a_1X_1 + \dots + a_nX_n &\mapsto [a_1X_1 + \dots + a_nX_n] \; \mod (\ker \pi_A)^2,
    %\end{align*}
    \begin{align*}
        \Phi\colon \ker \pi_U &\to (\ker \pi_A)/(\ker \pi_A)^2 = \phi_A\\
        f &\mapsto [f] \; \mod (\ker \pi_A)^2,
    \end{align*}
    where \([f]\) denotes the image of \(f\) in \(A\).
    Then, as \(\pi_A([f]) = f(0)\), we get that \(X_i \in \ker \pi_A \forall i\)
    and therefore \([f] \in \ker \pi_A \forall f \in \ker \pi_U\). Not only is \(\Phi\) welldefined,
    we can conclude that \(X_i \in \ker \pi_A \implies X_i^2 \in (\ker \pi_A)^2\)
    and therefore \(\Phi\) is also surjective and \((\ker \pi_U)^2 \subset \ker \Phi\).
    
    With this knowledge we get a welldefined surjective map
    \begin{align*}
        \tilde \Phi\colon \phi_U = \mathcal{O}X_1 \oplus \dots \oplus \mathcal{O}X_n &\to \phi_A\\
        a_1X_1 + \dots + a_nX_n \; \mod (\ker \pi_U)^2 &\mapsto [a_1X_1 + \dots + a_nX_n] \; \mod (\ker \pi_A)^2.
    \end{align*}
    Elements in the kernel of this map are either generated by \(X_i^2\) s.t. they become 0 \(\mod (\ker \pi_A)^2\)
    or they become 0 by sending them to \(A = U/(f_i)\).
    As higher order terms of \(f_i\) are vanishing anyways, 
    the kernel of \(\tilde \Phi\) is generated by the \(\overline{f_i}\), i.e.
    \[
        \phi_A \cong \phi_U/(\overline{f_i})  
    \]
\end{proof}

\begin{example}\label{ex:first_phi}
    We now compute \(\phi_A\) where \(A\) was defined in \cref{ex:first_1}.
    Remember that \(f = T(T-\lambda^n) = -\lambda^n T + T^2\). Therefore,
    \[\phi_A = \mathcal{O}T/(-\lambda^n T) = \mathcal{O}/\lambda^n.\]
\end{example}

\begin{definition}
    Let \(A \in \cob\). Then
    \[\eta_A \coloneqq \pi_A(\ann_A (\ker \pi_A))\] is an ideal in \(\mathcal{O}\).
\end{definition}

\begin{example}
    We now compute \(\eta_U\) for \(U\) from \cref{ex:last_1}.
    \begin{align*}
        \eta_U &= \pi_U(\ann \ker \pi_U)\\
        &= \pi_U(\ann \mathcal{O}X_1 \oplus \dots \oplus \mathcal{O}X_n)\\
        &= \pi_U(0) = 0.
    \end{align*}
\end{example}

\begin{lemma}\label{lem:ideals}
    Let \(\mathfrak a \subset \mathcal{O}\) be an ideal. Then
    \[\mathfrak a \neq 0 \implies \mathcal{O}/\mathfrak a \text{ finite}.\]
\end{lemma}
\begin{proof}
    As \(\mathcal{O}\) is a DVR, \(\mathfrak a = \lambda^n\) for some \(n \in \mathbb N\) 
    where \(\lambda\) is the maximal ideal in \(\mathcal{O}\).
    Therefore, \(\mathcal{O}/\mathfrak{a} = \mathcal{O}/\lambda^n.\)

    Using the fact that \(\lambda = (t)\) for some uniformizer \(t\), we get \(\forall i \ge 1\) 
    the isomorphism \(\lambda^i/\lambda^{i+1} \cong \mathcal{O}/\lambda = k\) and thereby also the short exact sequence 
    \[0 \to \mathcal{O}/\lambda \cong \lambda^i/\lambda^{i+1} \to \mathcal{O}/\lambda^{i+1} \to \mathcal{O}/\lambda^{i} \to 0.\]
    As \(k = \mathcal{O}/\lambda\) is finite, we can use induction
    \[\# \mathcal{O}/\lambda^{i+1} = \# \mathcal{O}/\lambda \cdot \# \mathcal{O}/\lambda^i = \# k \cdot (\# k)^i = (\# k)^{i+1}\]
    and get \(\# \mathcal{O}/\mathfrak{a} = \# \mathcal{O}/\lambda^n = (\# k)^n\).
\end{proof}

\begin{example}\label{ex:first_eta}
    We now compute \(\eta_A\) for \(A\) from \cref{ex:first_1}.
    \begin{align*}
        \eta_A &= \pi_A(\ann \ker \pi_A)\\
        &= \pi_A(\ann \{(0, b) \subset \mathcal{O}\times \mathcal{O} | b \equiv 0 \mod \lambda^n\})\\
        &= \pi_A(\{(a, 0) \subset \mathcal{O}\times \mathcal{O} | a \equiv 0 \mod \lambda^n\})\\
        &= \pi_A((\lambda^n) \times \mathcal{O})\\
        &= (\lambda^n)
    \end{align*}
\end{example}

With these results at hand, we can state 
\begin{theorem}\textup{\cite[theorem 5.3]{darmon1995fermat}}\label{thm:wiles_numerical_criterion}
    Let \(R \twoheadrightarrow T\) a surjective morphism of augmented rings, \(T\) finite flat and \(\eta_T \neq 0\) 
    (i.e. \(\mathcal{O}/\eta_T\) finite).
    Then the following are equivalent
    \begin{enumerate}[(a)]
        \item \(\# \phi_R \le \#(\mathcal{O}/\eta_T)\),
        \item \(\# \phi_R = \#(\mathcal{O}/\eta_T)\),
        \item \(R\) and \(T\) are complete intersections, and \(R \to T\) is an isomorphism.
    \end{enumerate}
\end{theorem}

\section{Basic properties of the invariants}
In this subsection we prove the equivalence (a) \(\Leftrightarrow\) (b) in \cref{thm:wiles_numerical_criterion}
by investigating the invariants \(\phi_A\) and \(\eta_A\) that we defined last section.

\begin{lemma}\label{lem:surjectivity_phi}
    A morphism \(f\colon A \to B \in \cob\) induces a homomorphism \(\phi_A \to \phi_B\) of \(\mathcal{O}\)-modules.
    This induced map is surjective if and only if the morphism \(A \to B\) is surjective.
\end{lemma}
For the 'only if'-part, see \cites[lemma 5.5]{darmon1995fermat}[theorem 8.4]{Matsumura1986}[ch. II, lemma 7.4]{Hartshorne1977}
\begin{proof}
    We have the commutative diagram
    \[
    \begin{tikzcd}[column sep=small]
        A \arrow[rr, "f"] \arrow [dr, "\pi_A", swap, twoheadrightarrow] & & B \arrow [dl, "\pi_B", twoheadrightarrow]\\
        & \mathcal{O} &
    \end{tikzcd}.
    \]
    It follows from the diagram that the restriction of \(f\) to \(\ker \phi_A\) maps to \(\ker \phi_B\),
    because \(\forall x \in \ker \phi_A\colon\; \pi_B(f(x)) = \pi_A(x) = 0\).
    Concatenating this with the projection to the tangent space, we get a map
    \[
        \tilde f\colon \ker \pi_A \to \ker \pi_B/(\ker \pi_B)^2 = \phi_B.
    \]
    In order to see that \(\tilde f\colon \phi_A \to \phi_B\) is welldefined, we need to show 
    \[
        f(\ker \pi_A)^2 \subset (\ker \pi_B)^2,
    \]
    however this follows from the fact that \(f(\ker \pi_A) \subset \ker \pi_B\) and that \(f\) is an algebra
    homomorphism:
    \[
        f(x^2) = \underbrace{f(x)}_{\in \ker \pi_B}\underbrace{f(x)}_{\in \ker \pi_B} \in (\ker \pi_B)^2 
    \]
    for any \(x \in \ker \pi_A\).

    First, let us assume that \(A \to B\) is a surjective map.
    In this case, every element \(x \in \ker \phi_B\) has a preimage in \(\ker \pi_A\). 
    Indeed, \(\forall y \in f^{-1}(x)\subset A\colon\)
    \[
        \pi_A(y) = \pi_B(f(y)) = \pi_B(x) = 0.
    \]
    As a result, the induced map \(f\colon \ker \pi_A \to \ker \pi_B\) and its concatenation with
    the projection to \(\phi_B\), \(\tilde f\colon \ker \pi_A \to \ker \pi_B/(\ker \pi_B)^2\) are both surjective.
    In total, we obtain a surjective homomorphism \(\tilde f\colon \phi_A \to \phi_B\).
    
    Now, let the induced map \(\phi_A \to \phi_B\) be surjective. 

    %We know that \(\ker \pi_A\) is an ideal in \(A\), hence \(\ker \pi_A \subset \mathfrak{m}_A\).
    %As \(A\) is complete, we have \(A \cong \varprojlim A/\mathfrak{m}_A^n\).
    %Now consider the map
    %\[
    %    A \to \varprojlim A/(\ker \pi_A)^n = \hat A.
    %\]
    \textbf{Why is \(A\) complete with respect to the \(\ker \pi_A\)-adic topology?}
    Consider the ideal \(I = f(\ker \pi_A) \cdot B\) in \(B\).
    Let \(x \in I\). Then \(x = \sum_i f(x_i) \cdot b_i\) for \(x_i \in \ker \pi_A\) and \(b_i \in B\).
    Remember the commutative diagram from the beginning of the proof,
    \[
        \pi_B(x) = \pi_B\left(\sum_i f(x_i)\cdot b_i\right) 
        = \sum_i \pi_B(f(x_i))\cdot \pi_B(b_i) 
        = \sum_i\pi_A(x_i)\cdot \pi_B(b_i) = 0. 
    \]
    As a result, \(I \subset \ker \pi_B \subset \mathfrak{m}_B\).
    Note that
    \[
        f(\ker \pi_A) \subset f(\ker \pi_A)\cdot B \implies f((\ker \pi_A)^n) 
        = f(\ker \pi_A)^n \subset (f(\ker \pi_A)\cdot B)^n,
    \]
    so we have \(\phi((\ker \pi_A)^n)\cdot B \subset I^n\).
    As \(B\) is \(\mathfrak{m}_B\)-adically complete and therefore Hausdorff, we get
    \[
        \bigcap_{n \in \mathbb N} f((\ker \pi_A)^n) \cdot B \subset \bigcap_{n \in \mathbb N} I^n 
        \subset \bigcap_{n \in \mathbb N} \mathfrak{m}_b^n = 0,
    \]
    i.e. \(\!B\) is separated with respect to the \(I\)-adic topology.
    Furthermore, \(\ker \pi_A\) is finitely generated as an \(A\)-module, 
    \(\ker \pi_A = \langle a_1, \dots, a_m\rangle\) because \(A\) is noetherian. 
    As \(\ker \pi_A \to (\ker \pi_B)/(\ker \pi_B)^2\) is surjective, we have 
    \[(\ker \pi_B)/(\ker \pi_B)^2 = \langle \overline{f(a_1)}, \dots, \overline{f(a_m)}\rangle_B.\]
    \textbf{As \(A\) is complete} and \(I\) is separated with respect to the \(I\)-adic topology 
    as a submodule of \(B\), we can apply Nakayama's Lemma as in Mat, 8.4. 
    It follows that the images \(\langle f(a_1), \dots, f(a_m)\rangle\) generate \(\ker \pi_B\)
    as a \(B\)-module. We already know that \(f(\ker \pi_A) \cdot B \subset \ker \pi_B\). 
    Together we have
    \[
        f(\ker \pi_A) \cdot B = \ker \pi_B.
    \]
    Now we conclude that \(1\) is a generator of \(B/I = B/f(\ker \pi_A) B = B/\ker \pi_B = \mathcal{O}\) as an 
    \(A/\ker \pi_A \cong \mathcal{O}\)-module.
    Applying Nakayama's Lemma again, we get that \(1\) is a generator of \(B\) as an \(A\)-module 
    and hence, \(f\colon A \to B\) is surjective.
\end{proof}

\begin{corollary}\label{cor:surjectivity_phi}
    Let \(A, B\in \cob\) and \(\phi_A\) be finite. Then \(\phi_B\) is finite as well
    and \(A \to B\) is surjective if and only if \[\# \phi_A \geq \# \phi_B.\]
\end{corollary}

\begin{lemma}\label{lem:surjectivity_eta}
    If \(f \colon A \to B\) is surjective, then
    \begin{equation}
        \eta_A \subset \eta_B, \quad \text{i.e. if \(\eta_A \neq 0\),}\quad \#(\mathcal{O}/\eta_A) \geq \#(\mathcal{O}/\eta_B).  
    \end{equation}
\end{lemma}
\begin{proof}
    As we have seen in the proof of \cref{lem:surjectivity_phi}, a surjective map \(f\) induces a surjective
    map on the kernels, \(f\colon \ker \pi_A \to \ker\pi_B\).
    Now let \(x \in \ann_A \ker \pi_A\), i.e. \(x \cdot a = 0\;\; \forall a \in \ker \pi_A\).
    For all \(b \in \ker \pi_B\) and any preimage \(a \in \ker \pi_A\) we have
    \[
        f(x) \cdot b = f(x) \cdot f(a) = f(x \cdot a) = f(0) = 0.
    \]
    As a result, \(f(x) \in \ann_B\ker \pi_B\) and we obtain a map
    \[
        \tilde f\colon\ann_A\ker \pi_A \to \ann_B \ker \pi_B.  
    \]
    In order to show \(\eta_A \subset \eta_B\), let \(x \in \eta_A = \pi_A(\ann_A \ker \pi_A)\), i.e.
    \(x = \pi_A(y)\) for some \(y \in \ann_A \ker \pi_A\). By the commutative diagram
    \[
    \begin{tikzcd}[column sep=small]
        \ann_A \ker \pi_A \arrow[rr, "\tilde f"] \arrow [dr, "\pi_A", swap, twoheadrightarrow] 
        & & \ann_B \ker \pi_B \arrow [dl, "\pi_B", twoheadrightarrow]\\
        & \mathcal{O} &
    \end{tikzcd},
    \]
    we get
    \[
        x = \pi_A(y) = \pi_B(\tilde f(y)) \in \pi_B(\ann_B \ker \pi_B) \implies x \in \eta_B,
    \]
    as desired.
\end{proof}

\begin{definition}
    Let \(M\) be a finitely generated \(R\)-module. Then \(M\) is a quotient
    \[
        P \colon R^n \longrightarrow M = R^n/\ker P
    \]
    We define \(\fitt_R(M) \coloneqq \langle \det(v_1, \dots, v_n) | v_i \in \ker P \rangle_R \subset R\).
    This is independent of the choice of the surjection (see e.g. stacks project).
\end{definition}

\begin{lemma}\label{lem:fitting_and_ann}
    For a finitely generated \(R\)-module \(M\) we have
    \[\fitt_R(M) \subset \ann_R(M).\]
\end{lemma}
\begin{proof}
    \(M\) is generated by \(\overline{e_1}, \dots, \overline{e_n}\) where \(\overline{x}\) 
    may denote the residue class of \(x \mod \ker P\).
    Now let \([v_1|\dots|v_n]\) be a matrix with \(v_i \in \ker P\). Then this matrix annihilates \(M\) because
    it annihilates all the generators \(\overline{e_i}\),
    \[
        [v_1|\dots|v_n] \cdot e_i = v_i \in \ker P.
    \]
    Let \(A\) be the adjugate matrix of \([v_1|\dots|v_n]\), i.e. \[A[v_1|\dots|v_n] = \det [v_1|\dots|v_n]\cdot I_{n\times n}.\]
    Let \(m \in M\) and \((m_i)_{i=1}^n\) a lift in \(R^n\). Then we have 
    \begin{align*}
        \det [v_1|\dots|v_n] \cdot m &= \det [v_1|\dots|v_n]\cdot I_{n\times n} (m_i)_{i=1}^n \\
        &= A[v_1|\dots|v_n]\left(\sum_{i=1}^n m_i e_i\right)\\
        &= A \cdot \sum_{i=1}^n m_i v_i \in A \cdot \ker P \subset \ker P
    \end{align*}
    Therefore \(\fitt_R(M) \subset \ann_R(M)\).
\end{proof}

\begin{remark}[Fitting ideals and \(\otimes\)]\label{rem:fitting_and_tensor}
    Let \(A \in \cob\) and \(M\) a finitely generated \(A\)-module. 
    Note that \(\mathcal{O}\) has an \(A\)-module structure via \(\pi_A\).
    We have
    \[
        \pi_A(\fitt_A(M)) = \fitt_\mathcal{O}(M \otimes_A \mathcal{O}).
    \]
    This follows from the fact that \(- \otimes_A \mathcal{O}\) is right exact. 
    Hence, from the exact sequence
    \[
        \ker P \longrightarrow A^n \longrightarrow M \longrightarrow 0
    \]
    we get the exact sequence
    \[
        \ker P \otimes_A \mathcal{O} \longrightarrow A^n\otimes_A \mathcal{O} = \mathcal{O}^n 
        \longrightarrow M\otimes_A \mathcal{O} \longrightarrow 0.
    \]
    The remaining details are left as an exercise to the reader.
\end{remark}

\begin{remark}[Fitting ideals for finitely generated \(O\)-modules]
    Let \(M\) be a finitely generated \(O\)-module. As \(O\) is a PID, there are unique \(r,s \in \mathbb{N}\) 
    and \(n_1 \geq dots \geq n_s \in \mathbb{N}\) s.t.
    \[
        M = \mathcal{O}^r \oplus \mathcal{O}/\lambda^{n_1} \oplus \dots \oplus \mathcal{O}/\lambda^{n_s}.
    \]
    If \(r > 0\) then every \(v \in \ker P \subset \mathcal{O}^{r + s}\) has \(r\) zero components.
    Therefore, \(\fitt_R (M) = 0\) for \(r > 0\).
    If \(r = 0\) the \(i\)-th component of \(v \in \ker P \subset \mathcal{O}^s\) 
    lies in the kernel of \(\mathcal{O} \to \mathcal{O}/\lambda^{n_i}\), 
    i.e. \(v_i \in \lambda^{n_i}\).
    Using the Leibniz formula for computing the determinant, we get
    \(\fitt_\mathcal{O}(M) = \lambda^{n_1} \cdot \dots \cdot \lambda^{n_s} = \lambda^{n_1 + \dots + n_s}\).
\end{remark}

\begin{corollary}\label{cor:fitting_finite}
    Let \(M\) be a finite \(\mathcal{O}\)-module. Then
    \[
        \# M = \# (\mathcal{O}/\fitt_\mathcal{O}(M)). 
    \]
\end{corollary}
\begin{proof}
    As \(M\) is finite, we get
    \[
        M = \mathcal{O}/\lambda^{n_1} \oplus \dots \oplus \mathcal{O}/\lambda^{n_s}
    \]
    and 
    \[
        \fitt_\mathcal{O}(M) = \lambda^{n_1 + \dots + n_s}.
    \]
    From the proof of \cref{lem:ideals} it follows that
    \[\# M = (\# k)^{n_1} \cdot \dots \cdot (\# k)^{n_s} = (\# k)^{n_1 + \dots + n_s}\]
    and
    \[
        \# (\mathcal{O}/\fitt_\mathcal{O}(M)) = \# (\mathcal{O}/\lambda^{n_1 + \dots + n_s}) = (\# k)^{n_1 + \dots + n_s}.
    \]
\end{proof}

\begin{lemma}\label{lem:standard_ineq}
    Let \(A \in \co\) s.t. \(\phi_A\) finite and \(\eta_A \neq 0\). Then \[\#\phi_A \geq \#(\mathcal{O}/\eta_A).\]
\end{lemma}
\begin{proof}
    As \(\mathcal{O} = A/\ker \pi_A\), we have
    \[
        \ker \pi_A \otimes_A \mathcal{O} = \ker \pi_A \otimes_A A/\ker \pi_A \cong \ker \pi_A/(\ker \pi_A) \ker \pi_A = \phi_A.
    \]
    We therefore have
    \[
        \fitt_\mathcal{O}(\phi_A) = \fitt_\mathcal{O}(\ker \pi_A \otimes_A\mathcal{O}) = \pi_A(\fitt_A(\ker \pi_A))
    \]
    where the second equality follows from \cref{rem:fitting_and_tensor}.
    Applying \cref{lem:fitting_and_ann} to the RHS, we get 
    \[
        \fitt_\mathcal{O}(\phi_A) \subset \pi_A(\ann_A(\ker \pi_A)) = \eta_A.
    \]
    As \(\phi_A\) is finite, we can apply \cref{cor:fitting_finite} to \(M = \phi_A\) and obtain
    \[
        \# \phi_A = \# (\mathcal{O}/\fitt_\mathcal{O}(\phi_A)) \geq \# (\mathcal{O}/\eta_A).
    \]
\end{proof}

\begin{proposition}\textup{\cite[cf.][corollary 5.6]{darmon1995fermat}}
    (a) \(\Leftrightarrow\) (b) in \cref{thm:wiles_numerical_criterion}.
\end{proposition}
\begin{proof}
    By assumption, \(R \to T\) is a surjective morphism in \(\cob\).
    With \cref{cor:surjectivity_phi} it follows that \(\#\phi_R \geq \#\phi_T\). \Cref{lem:standard_ineq} 
    tells us that \(\#\phi_T \geq \#(\mathcal{O}/\eta_T)\).
    The inequalities combine to \[\#\phi_R \geq \#(\mathcal{O}/\eta_T).\]
    In both cases the finiteness of \(\mathcal{O}/\eta_T\) implies the finiteness of \(\phi_R\)
    and from that we obtain the finiteness of \(\#\phi_T\).
    \begin{itemize}
        \item[(a)\(\implies\)(b)] (a) gives us \(\#\phi_R \leq \#(\mathcal{O}/\eta_T)\), so combined with the 
        inequality \(\#\phi_R \geq \#(\mathcal{O}/\eta_T)\) we have just proven we conclude that (b) must hold.
        \item[(b)\(\implies\)(a)] Obvious.
    \end{itemize}      
\end{proof}

\section{Regular sequences and the Koszul complex}
Let \(A\) be a finite flat complete intersection. Hence we can write 
\[A = \mathcal{O}[[X_1, \dots, X_n]]/(f_1, \dots, f_n).\]
The goal of this section is to prove some technical lemmata and to introduce
the Koszul complex that we will use to construct two \(\mathcal{O}[[X]]\)-free resolutions for \(A\).
This will turn out to be crucial in the next section.

We start with a few definitions from commutative algebra, closely following \cite[sec. 5.3]{darmon1995fermat}
\begin{definition}[primary ideal]
    Let \(R\) be a local ring and \(\mathfrak{a} \subsetneq R\) an ideal. 
    \(\mathfrak{a}\) is said to be primary if every zero divisor in \(R/\mathfrak{a}\) is nilpotent.
\end{definition}
Recall that the dimension of a ring is given by
\[
    \sup \left\{n | 
                \mathfrak{p}_0 \subsetneq \dots \subsetneq \mathfrak{p}_n \subsetneq R,\; \mathfrak{p}_i \text{ prime} 
        \right\}.
\]
\begin{definition}[system of parameters]
    Let \(x_1, \dots, x_n\) generate a primary ideal of \(R\). If \(n = \dim R\) then \(x_1, \dots, x_n\) is called 
    a system of parameters.
\end{definition}

\begin{lemma}\label{lem:sys_params}\textup{\cite[lemma 5.10]{darmon1995fermat}}
    The sequence \((f_1, \dots, f_n, \lambda)\) is a system of parameters for \(U\) (cf. \cref{ex:last_1}).
\end{lemma}
\begin{proof}
    First, we show that \(\dim U = n + 1\).
    We have an ascending chain of prime ideals
    \[
        (0) \subsetneq (\lambda) \subsetneq \dots \subsetneq (\lambda, X_1, \dots, X_n),  
    \]
    so by definition of the dimension we get \(\dim U \geq n + 1\).
    %Corollary 26.18 of Prof. Schmidt's Algebra script
    Let \(\mathfrak{m} = (\lambda, X_1, \dots, X_n)\). We have seen that this is the maximal ideal in \(U\).
    Now we can conclude
    \[
        \dim U \leq \dim_{U/\mathfrak{m}}(\mathfrak{m}/\mathfrak{m}^2) 
        = \dim_k(\lambda/\lambda^2 \oplus k X_1 \oplus \dots \oplus k X_n).
    \]
    As \(\lambda/\lambda^2 \cong k\) (cf. \cref{lem:ideals}), the above expression evaluates to \(n+1\) and
    taking both inequalities together we obtain \(\dim U = n + 1\).
    It remains to show that \((f_1, \dots, f_n, \lambda)\) generate a primary ideal of \(U\).
    \(U\) is local and therefore the quotient ring 
    \[\tilde{U} \coloneqq U/(f_1, \dots, f_n, \lambda)\] 
    is local as well.
    Also, \(\tilde U\) is a \(k\)-vector space (because it's an \(\mathcal{O}\)-module and \(\lambda\)-operation
    annihilates it). As \(A = U/(f_1, \dots, f_n)\) is a finitely generated \(\mathcal{O}\)-module, we can find
    \((x_1, \dots, x_N)\) that generate \(A\) as \(\mathcal{O}\)-module.
    These \(x_i\) then generate \(\tilde U\) as a \(k\)-vector space.
    As \(k\) is finite, the whole vector space is finite.
    As a result, the chain of powers of \(\mathfrak{m}_{\tilde U}\) must stabilize,
    \[
        \mathfrak{m}_{\tilde U}^n = \mathfrak{m}_{\tilde U}^{n+1}
    \]
    By Nakayama's lemma it follows that \(\mathfrak{m}_{\tilde U}^n = 0\).
    As a result, every element of the maximal ideal is nilpotent.
    Zero-divisors are never units. Hence they are contained in the maximal ideal and, a fortiori, nilpotent.
    In total, \(f_1, \dots, f_n, \lambda\) generate a primary ideal of \(U\).
\end{proof}

\begin{definition}[regular sequence]\cite[cf.][\S 16]{Matsumura1986}
    A sequence \((x_1, \dots, x_n)\) is said to be a regular sequence 
    if \(\forall\; i = 1, \dots, n\colon\)
    \[x_i \text{ is not a zero-divisor in } R/(x_1, \dots, x_{i-1}).\]
\end{definition}

\begin{lemma}\label{lem:reg_seq}\textup{\cite[lemma 5.11]{darmon1995fermat}}
    The sequence \((f_1, \dots, f_n)\) is a regular sequence for \(U\).
\end{lemma}
\begin{proof}
    The sequence \((\lambda, X_1, \dots, X_n)\) is a regular sequence for \(U\) because
    \(U/\lambda = k[[X_1, \dots, X_n]]\) and \(U/(\lambda, X_1, \dots, X_{i-1}) = k[[X_i, \dots, X_n]]\) 
    are integral domains (hence obviously \(X_i\) can't be a zero-divisor in these rings).
    As we have seen in the previous lemma, it's as well a system of parameters.
    Therefore, the depth of \(U\) (i.e. the maximal lenth of any regular sequence in \(U\)) is bigger than
    the length of the particular regular sequence \((\lambda, X_1, \dots, X_n)\).
    In total we get \(\operatorname{depth} U \geq \dim U\), because \((\lambda, X_1, \dots, X_n)\) 
    is a system of parameters as well.
    %source?
    In general, we have \(\operatorname{depth} R \leq \dim R\) for a noetherian local ring \(R\), 
    so combined we have
    \[
        \operatorname{depth} U = \dim U  
    \]
    and hence, \(U\) is Cohen-Macaulay.
    %Matsumura, Theorem 17.4
    As \((f_1, \dots, f_n, \lambda)\) is a system of parameters and \(U\) is Cohen-Macaulay
    it follows by [Matsumura, Theorem 17.4] that \((f_1, \dots, f_n, \lambda)\) is a regular sequence.
    A fortiori, the sequence \((f_1, \dots, f_n)\) is also a regular sequence.
\end{proof}

\begin{corollary}\textup{\cite[corollary 5.12]{darmon1995fermat}}\label{cor:flatness}
    Let \(A \in \cob\) be finitely generated and of the form
    \[
        A \cong \mathcal{O}[[X_1, \dots, X_n]]/(f_1, \dots, f_n).  
    \]
    Then \(A\) is flat.
\end{corollary}
\begin{proof}
    Assume that \(A\) is not flat, i.e. there is a \(\lambda^n u \in \mathcal{O}\) and a
    \[0 \neq g(X_1, \dots, X_n) \in A \qquad \text{s.t. } \lambda^m u \cdot g(\underline{X}) = 0.\]
    Consider \(g' = \lambda^{m-1}u g\). 
    Either \(g' \neq 0\) s.t. \(\lambda \cdot g' = 0\) with \(g' \neq 0\) or \(g' = 0 \in A\).
    Then repeat the last step with \(g'\) instead of \(g\). After finitely many steps we find a \(0 \neq g \in A\) s.t. 
    \(\lambda g = 0\), i.e.
    \[
        \lambda \cdot g(\underline{X}) = c_1(\underline{X})f_1(\underline{X}) + \dots + c_n(\underline{X})f_n(\underline{X}). 
    \]
    Without loss of generality we can choose the \(c_i(\underline{X})\) in such a way that \(c_i(\underline{X})\) 
    is never divisible by any of the \(f_{j}(\underline{X})\) for \(j < i\). 
    (In such a case one would have to add a suitable multiple of \(f_i\) to \(c_j\).)
    Furthermore, \(\exists i\colon\;0 \neq c_i \mod \lambda\). Otherwise we could divide the whole equation by
    \(\lambda\) and obtain \(g = 0 \mod (f_1, \dots, f_n)\), a contradiction. Let \(i_0\) be the biggest such \(i\).
    In the proof of \cref{lem:sys_params} we have never used that \(A\) is flat, 
    only that it is finitely generated. Therefore we know that \(\lambda, f_1, \dots, f_n\) is a system of parameters
    for \(U\). 
    From the proof of \cref{lem:reg_seq} (where we also haven't used that \(A\) is flat) we can deduce that
    \(\lambda, f_1, \dots, f_n\) is also a regular sequence for \(U\) and, a fortiori, \(f_{i_0}\) is not a 
    zero-divisor in \(U/(\lambda, f_1, \dots, f_{i_0-1})\).
    If we consider the equation
    \[
        \lambda \cdot g(\underline{X}) = c_1(\underline{X})f_1(\underline{X}) + \dots + c_n(\underline{X})f_n(\underline{X}). 
    \]
    \(\mod (\lambda, f_1, \dots, f_{i_0-1})\) we obtain
    \[
        0 = 0 + c_{i_0} f_{i_0} + 0,
    \]
    as all other terms are in the ideal \((\lambda, f_1, \dots, f_{i_0-1})\).
    We know that \(c_{i_0}\) is not divisible by any of \(\lambda, f_1, \dots, f_{i_0}\).
    Therefore \(f_{i_0}\) is a zero-divisor in \(U/(\lambda, f_1, \dots, f_{i_0-1})\). This is a contradiction,
    so our assumption must be false.
\end{proof}

%The Koszul complex
\begin{definition}[Koszul complex]\cites[ch. 5.3]{darmon1995fermat}[\S 16]{Matsumura1986}
    The Koszul complex associated to a sequence \(\underline{x} = (x_1, \dots, x_n)\) contained in the maximal ideal
    of a local ring is given by the complex
    \[
        0 \to K_n(\underline{x}, R) \xrightarrow{d_n} K_{n-1}(\underline{x}, R) \to \dots \to K_{0}(\underline{x},R) \to 0,
    \]
    where 
    \[
        K_p(\underline{x}, R) \coloneqq \bigoplus_{i_1 < \dots < i_p} R \cdot u_{i_1}\wedge\dots\wedge u_{i_p}
    \]
    for symbols \(u_1, \dots, u_n\). The differential map \(d_p\colon K_p(\underline{x}, R) \to K_{p-1}(\underline{x}, R)\)
    is given by
    \[
        d_p(u_{i_1}\wedge\dots\wedge u_{i_p}) = \sum_{t=1}^p(-1)^t x_{i_t} \cdot 
        u_{i_1} \wedge \dots \wedge \widehat{u_{i_t}}\wedge \dots \wedge u_{i_p}.
    \]
    As usual, we denote by \(H_p(\underline{x}, R)\) the \(p\)-th homology group of this complex.
\end{definition}

\begin{remark}\textup{\cites[proposition 5.13]{darmon1995fermat}[theorem 16.5 (i)]{Matsumura1986}}
    We note \(K_0(\underline{x}, R) = R\) and therfore compute
    \[
        H_0(\underline{x}, R) = K_0(\underline{x}, R)/(\im d_1) \cong R/(x_1, \dots, x_n) = R/(\underline{x}).
    \]
    Furthermore, one can show that if \((\underline{x})\) is a regular sequence, then the complex is exact.
    As it consists of free \(R\)-modules, homological algebra shows that we then get a resolution of
    \(H_0(\underline{x}, R) = R/(\underline{x})\) by free \(R\)-modules. 
    %if I have time and motivation I can probably give some more proofs here
\end{remark}

\section{Complete intersections and Gorenstein rings}
Let \(A\) be a finite flat complete intersection in \(\cob\). The goal of this section is to show that \(A\)
satisfies a Gorenstein condition, i.e. a specific form of self-duality.
This fact can then be used to show (c) \(\implies\) (b) in \cref{thm:wiles_numerical_criterion}.
Although there is a very general notion of Gorenstein rings, for
the purpose of this proof we only need a special case,
\begin{definition}
    Let \(A \in \co\) be finite flat. \(A\) is called Gorenstein, if there is an isomorphism of \(A\)-modules
    \[
        \Psi\colon \hom_\mathcal{O}(A, \mathcal{O}) \cong A.
    \]
\end{definition}

Our goal therefore reduces to constructing an \(A\)-module isomorphism
\[
    \hom_\mathcal{O}(A, \mathcal{O}) \to A.
\]

We start with some useful constructions and conventions.
\begin{notation}
    For any ring \(R\) write \(R[[\underline{X}]] \coloneqq R[[X_1, \dots, X_n]]\).
\end{notation}

Let \(a_1, \dots, a_n\) be the images in \(A\) of \(X_1, \dots, X_n\) by the natural map
\[
    \alpha \colon \mathcal{O}[[\underline{X}]] \to A = \mathcal{O}[[\underline{X}]]/(f_1, \dots, f_n),
\]
and let
\[
    \beta \colon A[[\underline{X}]] \to A  
\]
be the natural map which sends \(X_i\) to \(a_i\). 
A polynomial \(f \in A[[\underline{X}]]\) is sent to \(0\) exactly when \(f(a_1, \dots, a_n) = 0\).
Therefore, \(\exists i\colon\; (X_i - a_i)|f\) and hence, 
the sequence \(g_i =  (X_i - a_i)\) generates the kernel of \(\beta\).
View the \(f_i\) as polynomials in \(A[[\underline{X}]]\) via the inclusion \(O \hookrightarrow A\). 
Then \(\forall i = 1, \dots, n\colon\)
\[
    \beta(f_i) = f_i(a_1, \dots, a_n) = 0 \in \mathcal{O}[[\underline{X}]]/(f_1, \dots, f_n).
\]
Therefore every of the \(f_i\) is element of \(\ker \beta\) and hence can be written as 
an \(A[[X]]\)-linear combination of the \(g_i\),
\[
    (f_1, \dots, f_n) = (g_1, \dots, g_n)M,  
\]
where \(M\) is an \(n \times n\) matrix with coefficients in \(A[[\underline{X}]]\). 
Let \(D = \det(M) \in A[[\underline{X}]]\).
The projection \(\mathcal{O}[[\underline{X}]] \to A\) induces an \(\mathcal{O}[[\underline{X}]]\)-module 
structure on \(A\).

\begin{lemma}\textup{\cite[see][lemma 5.14]{darmon1995fermat}}
    The map
    \begin{align*}
        \Phi\colon \hom_{\mathcal{O}[[\underline{X}]]}(A[[\underline{X}]], \mathcal{O}[[\underline{x}]]) &\to A\\
        f &\mapsto \alpha(f(D))
    \end{align*}
    is an \(\mathcal{O}[[\underline{X}]]\)-linear surjection.
\end{lemma}
\begin{proof}
    As shown in \cref{lem:reg_seq}, \((\underline{f}) = (f_1, \dots, f_n)\) 
    is a regular sequence for \(\mathcal{O}[[\underline{X}]]\).
    In the ring \(A[[\underline{X}]]/(X_1 - a_1, \dots, X_{i-1} - a_{i-1})\), there are no relations in \(X_i\),
    i.e. it can be written as \(R[X_i]\) for a ring \(R\). Therefore \((X_i - a_i)\) can't be a zero-divisor.
    As this holds for all \(i = 1, \dots, n\), \((\underline{g}) = (g_i) = (X_i - a_i)\) is a regular sequence 
    for \(A[[\underline{X}]]\).
    
    Let now \(K(\underline{f}, \mathcal{O}[[\underline{X}]])\) and \(K(\underline{g}, A[[\underline{X}]])\)
    be the associated Koszul complexes. 
    %Koszul complex property 1:
    We have that \(K(\underline{f}, \mathcal{O}[[\underline{X}]])\) is a resolution of 
    \[
        A = H_0(\underline{f}, \mathcal{O}[[\underline{X}]]) = \mathcal{O}[[\underline{X}]]/(f_1, \dots, f_n)
    \]
    by free \(\mathcal{O}[[\underline{X}]]\)-modules
    and analogous that \(K(\underline{g}, A[[\underline{X}]])\) is a resolution of
    \[
        A = H_0(\underline{g}, A[[\underline{X}]]) = A[[\underline{X}]]/(X_1 - a_1, \dots, X_n-a_n)
    \]
    by free \(A[[\underline{X}]]\)-modules.
    Every free \(A[[\underline{X}]]\)-module has a canonical \(\mathcal{O}[[\underline{X}]]\)-module structure 
    (take the canonical inclusion \(\mathcal{O} \hookrightarrow A, x \mapsto x\cdot 1\) and extend it to a map
    \(\mathcal{O}[[\underline{X}]] \hookrightarrow A[[\underline{X}]]\)).

    In the following, we want to construct a map of complexes
    \[\Phi\colon K(\underline{f}, \mathcal{O}[[\underline{X}]]) \to K(\underline{g}, A[[\underline{X}]]).\]
    On the 0-th level, we define 
    \[
        \phi_0 \colon K_0(\underline{f}, \mathcal{O}[[\underline{X}]]) = \mathcal{O}[[\underline{X}]] 
        \to 
        K_0(\underline{g}, A[[\underline{X}]]) = A[[\underline{X}]]
    \]
    to be just the canonical inclusion \(\mathcal{O}[[\underline{X}]] \hookrightarrow A[[\underline{X}]]\)
    as explained above.
    %Koszul complex property 2:
    On the first level, let
    \[
        \Phi_1 \colon 
            K_1(\underline{f}, \mathcal{O}[[\underline{X}]]) = \bigoplus_{i = 1}^n R \cdot u_i
            \to 
            K_1(\underline{g}, A[[\underline{X}]]) = \bigoplus_{i=1}^n R \cdot v_i
    \]
    be the map defined by
    \[
        (\Phi_1(u_1), \dots, \Phi_1(u_n)) = (v_1, \dots, v_n)M. %probably explain this in greater detail
    \]
    By skew-linearity this can be extended to a map of exterior algebras. %What exactly is an exterior algebra?
    In the following we proof that \(\Phi\)
    \begin{enumerate}
        \item is a morphism of complexes,
        \item induces the identity on \(A = H_0(\underline{f}, \mathcal{O}[[\underline{X}]])\)
        \item and satisfies
        \[
            \Phi_n(u_1 \wedge \dots \wedge u_n) = D \cdot v_1 \wedge \dots \wedge v_n.  
        \]
    \end{enumerate}
    \begin{enumerate}
        \item \textbf{\(\Phi\) is a morphism of complexes.}
        It is clear by definition that \(\Phi\) is welldefined on every level.
        We have to show that \(\Phi\) commutes with the differentials of the complex,
        \begin{align*}
            \Phi_{p-1}(d(u_{i_1}\!\wedge\!\dots\!\wedge\!u_{i_p})) 
            &= \Phi_{p-1}\left(\sum_{t=1}^p(-1)^t x_{i_t} 
            u_{i_1}\!\wedge\!\dots\!\wedge\!\widehat{u_{i_t}}\!\wedge\!\dots\!\wedge\!u_{i_p}\right)\\
            &= \sum_{t=1}^p(-1)^t x_{i_t}\Phi_1(u_{i_1})\!\wedge\!\dots\!
            \wedge\widehat{\Phi_1(u_{i_t})}\!\wedge\!\dots\!\wedge\!\Phi_1(u_{i_p})\\
            &= d(\Phi_1(u_{i_1})\wedge\dots\wedge \Phi_1(u_{i_p}))\\
            &= d(\Phi_p(u_{i_1}\wedge\dots\wedge u_{i_p})).
        \end{align*}
        \item \textbf{\(\Phi\) induces the identity on \(A = H_0(\underline{f}, \mathcal{O}[[\underline{X}]])\)}\\
        We have the following commutative diagram
        \[
            \begin{tikzcd}
                \bigoplus_{i=1}^n u_i \mathcal{O}[[\underline{X}]] = K_1(\underline{f}, \mathcal{O}[[\underline{X}]]) 
                \arrow[r, "d_1"] \arrow[d, "\Phi_1"] & K_0(\underline{f}, \mathcal{O}[[\underline{X}]]) \arrow[r, "d_0"] 
                \arrow[d, hook, "\Phi_0"] = \mathcal{O}[[\underline{X}]] & 0\\
                \bigoplus_{i=1}^n v_i A[[\underline{X}]] = K_1(\underline{g}, A[[\underline{X}]]) 
                \arrow[r, "d_1"] & K_0(\underline{g}, A[[\underline{X}]]) = A[[\underline{X}]] \arrow[r, "d_0"] & 0
            \end{tikzcd}.
        \]
        As 
        \[
            H_0(\underline{f}, \mathcal{O}[[\underline{X}]]) = \frac{\ker d_0}{\im d_1} 
            = \frac{\mathcal{O}[[\underline{X}]]}{(f_1, \dots, f_n)}
        \] and
        \[
            H_0(\underline{g}, A[[\underline{X}]]) = \frac{\ker d_0}{\im d_1} 
            = \frac{A[[\underline{X}]]}{(g_1, \dots, g_n)}
        \]
        we can take a look at the map
        \[
            \mathcal{O}[[\underline{X}]] \to \frac{A[[\underline{X}]]}{(X_1 - a_1, \dots, X_n - a_n)} = A.
        \]
        This map sends \(X_i\) to \(a_i \in A\).
        By definition of \(A = \mathcal{O}[[\underline{X}]]/(f_1, \dots, f_n)\) and \(a_i\) as image of \(X_i\)
        under \(\alpha\) this is exactly the map \(\alpha\). Hence, the induced map
        \[
            A = \mathcal{O}[[\underline{X}]]/(f_1, \dots, f_n) \to 
            \frac{A[[\underline{X}]]}{(X_1 - a_1, \dots, X_n - a_n)} = A
        \]
        is identity.
        \item Let \(M = (M_{i,j})_{i,j}\). Then we have
        \begin{align*}
            \Phi_n(u_1 \wedge \dots \wedge u_n) &= \Phi(u_1) \wedge \dots \wedge \Phi(u_n)\\
            &= \sum_{j=1}^n v_jM_{j,1} \wedge \dots \wedge \sum_{j=1}^n v_jM_{j,n}\\
            &= \underbrace{\sum_{\sigma \in \mathfrak{S}(n)} (-1)^{\operatorname{sgn}(\sigma)} 
            \prod_{i=1}^n M_{i,\sigma(i)}}_{= \det M} \cdot v_1 \wedge \dots \wedge v_n\\
            &= D \cdot v_1 \wedge \dots \wedge v_n,
        \end{align*}
        where \(\mathfrak{S}(n)\) may denote the group of permutations.
    \end{enumerate}
    In the following we write 
    \(K_\bullet(\underline{f}) = K_\bullet(\underline{f}, \mathcal{O}[[\underline{X}]])\)
    and 
    \(K_\bullet(\underline{g}) = K_\bullet(\underline{g}, A[[\underline{X}]])\)
    By applying the functor \(\hom_{\mathcal{O}[[\underline{X}]]}(-, \mathcal{O}[[\underline{X}]])\)
    to the two free resolutions, we get the following commutative diagram
    \[
        \begin{tikzcd}[column sep=2.2em]
            \arrow[r, "d_{n-1}^*"] & 
            \hom_{\mathcal{O}[[\underline{X}]]}(K_{n-1}(\underline{f}), \mathcal{O}[[\underline{X}]]) 
            \arrow[r, "d_n^*"] &
            \hom_{\mathcal{O}[[\underline{X}]]}(K_n(\underline{f}), \mathcal{O}[[\underline{X}]]) 
            \arrow[r] & 0\\
            \arrow[r, "d_{n-1}^*"] & 
            \hom_{\mathcal{O}[[\underline{X}]]}(K_{n-1}(\underline{g}), \mathcal{O}[[\underline{X}]])
            \arrow[r, "d_n^*"] \arrow[u, "\Phi_{n-1}^*"] &
            \hom_{\mathcal{O}[[\underline{X}]]}(K_n(\underline{g}), \mathcal{O}[[\underline{X}]]) 
            \arrow[r] \arrow[u, "\Phi_{n}^*"] & 0
        \end{tikzcd}.
    \]
    As both resolutions are free and, a fortiori, projective we can use the fact from homological algebra
    that there exists a homotopy equivalence that induces identity on the zero-th homology groups.
    Consider the following commutative diagram with exact rows
    \[
            \begin{tikzcd}
                \bigoplus_{i=1}^n u_i \mathcal{O}[[\underline{X}]] \arrow[r, "d_1"] \arrow[d, dashed] 
                &\mathcal{O}[[\underline{X}]]  \arrow[r, "\alpha"] \arrow[d, dashed] & A \arrow[r] \arrow[d, "\mathrm{id}"] & 0\\
                \bigoplus_{i=1}^n v_i A[[\underline{X}]] \arrow[r, "d_1"] 
                & A[[\underline{X}]] \arrow[r, "X_i \mapsto a_i"] & A \arrow[r] & 0
            \end{tikzcd}.
        \]
    From projectiveness we can conclude that there is a lift of the map \(\mathrm{id} \circ \alpha\) to a map 
    \(\mathcal{O}[[\underline{X}]] \to A[[\underline{X}]]\) along the map \(X_i \mapsto a_i\). 
    As both maps send \(X_i \mapsto a_i\), our lift is given by \(X_i \mapsto X_i\), i.e. it is exactly \(\Phi_0\).
    By commutativity, \((f_1, \dots, f_n) = \im d_1 = \ker \alpha\) maps to the kernel of \(X_i \mapsto a_i\). Therefore, we can lift the map
    \(\Phi_0 \circ d_1\) along the surjective map 
    \[
        d_1 \colon \bigoplus_{i=1}^n v_i A[[\underline{X}]] \to \im d_1 = \ker(X_i \mapsto a_i) = (g_1, \dots, g_n).
    \]
    Using \((f_1, \dots, f_n) = (g_1, \dots, g_n)M\), we obtain for the induced map \(f\)
    \begin{multline*}
        d_1(f(u_i)) = \Phi_0(d_1(u_i)) = \Phi_0(-f_i) = - \sum_{j=1}^n g_jm_{ji}\\
        = \sum_{j=1}^n d_1(v_j)m_{j_i} = d_1\left(\sum_{j=1}^n v_j m_j\right).
    \end{multline*}
    We note that \(f = \Phi_1\). 
    As the higher maps are then uniquely defined by skew linearity, we get that \(\Phi\) needs to be a homotopy equivalence.
    Hence, we have an isomorphism on the \(n\)-th cohomology,
    \[
        \Phi_n^*\colon \hom_{\mathcal{O}[[\underline{X}]]}(K_n(\underline{g}), \mathcal{O}[[\underline{X}]])/(\im d_n^*)
        \to \hom_{\mathcal{O}[[\underline{X}]]}(K_n(\underline{f}), \mathcal{O}[[\underline{X}]])/(\im d_n^*).
    \]
    We know that 
    \begin{alignat*}{3}
        &K_n(\underline{f}) &&= \bigoplus_{i = 1}^n \mathcal{O}[[\underline{X}]] \cdot u_1\wedge\dots\wedge u_n
        &&\cong \mathcal{O}[[\underline{X}]]\qquad\text{ and}\\
        &K_n(\underline{g}) &&= \bigoplus_{i = 1}^n A[[\underline{X}]] \cdot u_1\wedge\dots\wedge u_n 
        &&\cong A[[\underline{X}]]. 
    \end{alignat*}
    Therefore, we can make the identification
    \[
        \hom_{\mathcal{O}[[\underline{X}]]}(K_n(\underline{f}), \mathcal{O}[[\underline{X}]])
        \cong \hom_{\mathcal{O}[[\underline{X}]]}(\mathcal{O}[[\underline{X}]], \mathcal{O}[[\underline{X}]])
        \cong \mathcal{O}[[\underline{X}]],
    \]
    where the second isomorphism sends \(f \mapsto f(1)\). The lift of \(1\) under the first isomorphism is 
    \(u_1\wedge\dots\wedge u_n\). Hence in total we send a map 
    \(f\) to \(f(u_1\wedge\dots\wedge u_n)\).
    As a next step, we compute the image of \(d_n^*\) in \(\mathcal{O}[[\underline{X}]]\).
    Let \(\varphi \in \hom_{\mathcal{O}[[\underline{X}]]}(K_{n-1}(\underline{f}), \mathcal{O}[[\underline{X}]])\).
    Then we have
    \[
        d_n^*(\varphi) = \varphi \circ d_n \colon K_n(\underline{f}) \xrightarrow{d_n} K_{n-1}(g) \xrightarrow{\varphi} 
        \mathcal{O}[[\underline{X}]],  
    \]
    where the composition is given by 
    \[
        \varphi(d_n(u_1 \wedge \dots \wedge u_n)) = \sum_{t=1}^n (-1)^t f_t 
        \varphi(v_1 \wedge \dots \wedge \widehat{v_t} \wedge \dots \wedge v_n), 
    \]
    as \(\varphi\) is \(\mathcal{O}[[\underline{X}]]\)-linear.
    By our identification we then send the whole map to 
    \[
        \varphi \circ d_n(u_1\wedge\dots\wedge u_n) = \sum_{t=1}^n (-1)^t f_t 
        \varphi(v_1 \wedge \dots \wedge \widehat{v_t} \wedge \dots \wedge v_n) \in \mathcal{O}[[\underline{X}]].
    \]
    The image of \(d_n^*\) is therefore generated by the \(f_t\) and we get 
    \[
        \hom_{\mathcal{O}[[\underline{X}]]}(K_n(\underline{f}), \mathcal{O}[[\underline{X}]])/(\im d_n^*) 
        \cong \mathcal{O}[[\underline{X}]]/(f_1, \dots, f_n) = A.
    \]
    As a result, \(\Phi_n^*\) induces a \(\mathcal{O}[[\underline{X}]]\)-linear surjection
    \[
        \Phi\colon \hom_{\mathcal{O}[[\underline{X}]]}(A[[\underline{X}]], \mathcal{O}[[\underline{X}]]) \cong 
        \hom_{\mathcal{O}[[\underline{X}]]}(K_n(\underline{g}), \mathcal{O}[[\underline{X}]]) \twoheadrightarrow A.
    \]
    \(\Phi\) takes a \(\mathcal{O}[[\underline{X}]]\)-linear map and applies \(\Phi_n^*\) to \(f\), resulting in 
    \[
        f \circ \Phi_n\colon \mathcal{O}[[\underline{X}]] \xrightarrow{\Phi_n} K_n(g) 
        \xrightarrow{f} \mathcal{O}[[\underline{X}]].
    \]
    After that it uses our previous identification 
    \(\hom_{\mathcal{O}[[\underline{X}]]}(\mathcal{O}[[\underline{X}]], \mathcal{O}[[\underline{X}]])
    \cong \mathcal{O}[[\underline{X}]]\) 
    and sends \(f \circ \Phi_n\) to its value on \(1\). Using the identifications 
    \(K_n(\underline{f})\cong \mathcal{O}[[\underline{X}]]\) and \(K_n(\underline{g})\cong A[[\underline{X}]]\), we obtain
    \[
        f \circ \Phi_n(1) = f \circ \Phi_n(u_1\wedge\dots\wedge u_n) = f(D\cdot v_1\wedge\dots\wedge v_n) = f(D).
    \]
    Finally we have to take the residue class \(\!\!\!\mod (f_1, \dots, f_n)\). 
    That is done by applying the projection map \(\alpha\). In total we get
    \[
        \Phi(f) = \alpha(f(D)),  
    \]
    as desired.
\end{proof}

\begin{lemma}\textup{\cite[lemma 5.15]{darmon1995fermat}}\label{lem:gorenstein}
    Let 
    \[
        \!\tilde{\cdot}\colon \hom_\mathcal{O}(A, \mathcal{O}) \to 
        \hom_{\mathcal{O}[[\underline{X}]]}(A[[\underline{X}]], \mathcal{O}[[\underline{X}]])
    \]
    be the map that assigns an \(\mathcal{O}[[\underline{X}]]\)-homomorphism
    \(\tilde f\colon A[[\underline{X}]] \to \mathcal{O}[[\underline{X}]]\) to the \(\mathcal{O}\)-homomorphism
    \(f \colon A \to \mathcal{O}\) by extending it with \(X \mapsto X\).
    Then define
    \[
        \Psi \colon \hom_\mathcal{O}(A, \mathcal{O}) \to A  
    \]
    via \(\Psi(f) = \alpha(\tilde{f}(D))\).
    This is an \(A\)-module isomorphism where the \(A\)-module structure on \(\hom_\mathcal{O}(A, \mathcal{O})\)
    is given by \(a \cdot f = (x \mapsto f(ax))\).
    In total we get that \(A\) is Gorenstein.
\end{lemma}
\begin{proof}
    \begin{enumerate}
        \item \(\Psi\) is \(A\)-linear.
        For any \(a \in A, a' \in \mathcal{O}[[\underline{X}]]\) we have by definition of \(\Psi\)
        \[
            \Psi(af) = \alpha(\tilde f(aD)) = \alpha(\tilde f((a - a')D + a'D))
            = \alpha(\tilde f((a-a')D)) + \alpha(\tilde f(a'D)),
        \]
        where in the last step we have used the linearity of \(\tilde f\) and \(\alpha\).
        Now choose \(a' \in \alpha^{-1}(a) \subset \mathcal{O}[[\underline{X}]]\), as \(\alpha\) is surjective.
        We can also understand \(a'\) as an element of \(A[[\underline{X}]]\) via the inclusion
        \(\iota\colon\mathcal{O}[[\underline{X}]] \hookrightarrow A[[\underline{X}]]\).
        It follows \(\beta(\iota(a')) = \alpha(a') = a = \beta(a)\). Therefore, \(a - \iota(a') \in \ker \beta\).
        By definition of the \(g_i\) as generators of \(\ker \beta\), we can write \(a - \iota(a')\) as an 
        \(A[[\underline{X}]]\)-linear combination of the \(g_i\).
        We further have
        \[
            (f_1, \dots, f_n) = (g_1, \dots, g_n) \cdot M.
        \]
        Multiplying with the adjugate matrix \(M'\) we get
        \[  
            (f_1, \dots, f_n) \cdot M' = (g_1, \dots, g_n) \cdot \underbrace{M \cdot M'}_{= D \cdot I_{n\times n}}.
        \]
        Hence, we can write \(g_i \cdot D\) (and therefore also \((a - \iota(a'))\cdot D\)) 
        as an \(A[[\underline{X}]]\)-linear combination of the \(f_i\),
        \[
            (a - \iota(a'))\cdot D = \sum_{i=1}^n a_i f_i.
        \]
        Using the \(\mathcal{O}[[\underline{X}]]\)-linearity of \(\tilde f\), we compute
        \begin{multline*}
            \alpha(\tilde f((a-a')D)) = \alpha\left(\tilde{f}\left(\sum_{i=1}^n a_i f_i\right)\right)\\
            = \alpha\left(\sum_{i=1}^n f_i \tilde{f}(a_i)\right) = \sum_{i=1}^n \alpha(f_i \cdot \tilde{f}(a_i)) = 0,
        \end{multline*}
        as \(f_i \in \ker \alpha\).
        Putting our results together, we obtain
        \[
            \Psi(af) = \alpha(\tilde f((a-a')D)) + \alpha(\tilde f(a'D)) = \alpha(\tilde f(a'D)),
        \]
        and again by \(\mathcal{O}[[\underline{X}]]\)-linearity of \(\tilde f\) we conclude
        \[
            \Psi(af) = \alpha(a'\tilde f(D)) = a \alpha(\tilde f(D)) = a \Psi(f).
        \]
        \item \(\Psi\) is surjective.
        As \(A\) is a finite flat \(O\)-algebra, we know by the classification of finitely generated modules
        over principal ideal domains that \(A\) consists of a free part and a torsion part. Because it is flat,
        however, the torsion part is 0 and therefore \(A\) is a free \(O\)-module.
        Therefore we have \(\mathcal{O}\)-module-isomorphisms
        \[
            \hom_\mathcal{O}(A, \mathcal{O}) \cong \hom_\mathcal{O}(\mathcal{O}^r, \mathcal{O})
            \cong \mathcal{O}^r,
        \]
        where \(r\) may denote the rank of \(\mathcal{O}\). 
        Therefore \(A\) and \(\hom_\mathcal{O}(A, \mathcal{O})\) are both free \(A\)-modules of the 
        same finite rank \(r\).
        Let \(f_1, \dots, f_r\) be a \(\mathcal{O}\)-basis of \(\hom_\mathcal{O}(A, \mathcal{O})\). 
        Then, the extended maps \(\tilde f_1, \dots \tilde f_r\) form a basis for
        \(\hom_{\mathcal{O}[[X]]}(A[[\underline{X}]], \mathcal{O}[[\underline{X}]]).\)
        \textbf{How?}
        We have seen that the map 
        \[
            \Phi\colon \hom_{\mathcal{O}[[\underline{X}]]}(A[[\underline{X}]], \mathcal{O}[[\underline{x}]]) \to A
        \] 
        is surjective.
        Therefore, \(\forall a \in A\colon \exists p_1, \dots, p_r \in \mathcal{O}[[\underline{X}]]\) s.t.
        \[
            a = \Phi(p_1 \tilde f_1 + \dots + p_r \tilde f_r).
        \]
        Now we can use the linearity of the involved maps,
        \begin{align*} 
                a &= \alpha((p_1 \tilde f_1 + \dots + p_r \tilde f_r)(D))
                = \Psi(\alpha(p_1) f_1 + \dots + \alpha(p_r) f_r).
        \end{align*}
        \item \(\Psi\) is injective.
        Analogous to the theorem for vector spaces, we know that a surjective homomorphism between two free modules 
        of the same finite rank is also injective.
        As this condition is satisfied by \(\hom_\mathcal{O}(A, \mathcal{O})\) and \(A\), 
        the lemma follows.
    \end{enumerate}
\end{proof}

\section{Explicit computation of \texorpdfstring{\(\eta\)}{η} for complete intersections}

In this section, \(A\) is always a finite flat complete intersection \(\in \cob\), 
i.e. \(A \cong \mathcal{O}[[X_1, \dots, X_n]]/(f_1, \dots, f_n)\).
The goal of this section is to find explicit formulas for \(\eta_A\) and \(\phi_A\) using
the relations \(f_i\). This allows us to show that (c) \(\implies\) (b) in \cref{thm:wiles_numerical_criterion}.
We closely follow \cite[chapter 5.4]{darmon1995fermat}.
\begin{notation}
    \(A^\vee \coloneqq \hom_\mathcal{O}(A, \mathcal{O})\) and similarly, \(\pi_A^\vee \colon \mathcal{O}^\vee \to A^\vee\) 
    may denote the dual map associated to \(\pi_A\colon A \to \mathcal{O}\).
\end{notation}
As we have seen in the last section, \(A^\vee \cong A\) as \(A\) is a complete intersection.
We choose one \(A\)-module isomorphism \(\Psi\colon A^\vee \to A\).
\begin{lemma}
    Any two \(A\)-module isomorphisms \(\Psi, \Psi' \colon A^\vee \to A\) differ by a unit.
\end{lemma}
\begin{proof}
    The composition \(\Psi' \circ \Psi^{-1} \colon A \to A\) is an \(A\)-module isomorphism from \(A\) to \(A\).
    Such an isomorphism is uniquely defined by its value on \(1\),
    \[
        \Psi' \circ \Psi^{-1}(x) = x \cdot \Psi' \circ \Psi^{-1}(1).
    \]
    As we have the same fact for the inverse map, we find that \(\Psi' \circ \Psi^{-1}(1) \in A^\times\).
    \(\Psi \circ \Psi^{-1}(1) = 1\), so \(\Psi' \circ \Psi^{-1} = x \cdot \Psi \circ \Psi^{-1}\).
    We conclude \(\Psi = x \cdot \Psi'\).
\end{proof}

\begin{lemma}
    Independent of the choice of \(\Psi,\) we have 
    \(\Psi \pi_A^\vee(\mathcal{O}^\vee) = \ann_A \ker \pi_A\) and, a fortiori
    \[
        \eta_A = \pi_A \Psi \pi_A^\vee(\mathcal{O}^\vee).  
    \]
\end{lemma}
\begin{proof}
    We first show \(\Psi \pi_A^\vee(\mathcal{O}^\vee) \subset \ann_A \ker \pi_A\).
    Let therefore \(\phi\colon \mathcal{O} \to \mathcal{O} \in \mathcal{O}^\vee\) and \(x \in \ker \pi_A\).
    It suffices to show that \(\Psi \pi_A^\vee(\phi) \cdot x = 0\).
    Taking into account the \(A\)-module structure of \(\hom_\mathcal{O}(A, \mathcal{O})\) 
    and the fact that \(\Psi\) is an \(A\)-module-isomorphism, we obtain
    \[
        \Psi \pi_A^\vee(\phi) \cdot x = \Psi(\phi \circ \pi_A) \cdot x = \Psi(x \cdot \phi \circ \pi_A) 
        = \Psi((y \mapsto \phi \circ \pi_A(x\cdot y))) = 0,
    \]
    as \(x \in \ker \pi_A\).
    In order to prove  \(\Psi \pi_A^\vee(\mathcal{O}^\vee) \supset \ann_A \ker \pi_A\), let \(a \in \ann_A \ker \pi_A\)
    and \(f \in \hom_\mathcal{O}(A, \mathcal{O})\) s.t. \(\Psi(f) = a\). Then \(\forall x \in \ker \pi_A\),
    \[
        0 = \Psi(f) \cdot x = \Psi((y \mapsto f(x\cdot y))) \implies f(x\cdot y) = 0 \forall y \in A \implies f(x) = 0.
    \]
    A fortiori, \(\ker \pi_A \subset \ker f\) and we get an induced map \(\tilde f\colon \mathcal{O} \cong A/\ker \pi_A \to \mathcal{O}\)
    s.t. \(f = \tilde f \circ \pi_A\). As a result, we can write
    \[
        a = \Psi(f) = \Psi(\tilde f \circ \pi_A) = \Psi(\pi_A^\vee(\tilde f)) \in \Psi(\pi_A^\vee(\mathcal{O}^\vee)).  
    \]
\end{proof}

\begin{lemma}
    Let 
    \[
        \!\tilde{\cdot}\colon \hom_\mathcal{O}(A, \mathcal{O}) \to 
        \hom_{\mathcal{O}[[\underline{X}]]}(A[[\underline{X}]], \mathcal{O}[[\underline{X}]])
    \]
    and \(\Psi\)
    be the maps known from \cref{lem:gorenstein} and \(D = \det M\) as defined in the previous section.
    Then,
    \[
        \pi_A \Psi \pi_A^\vee(\mathcal{O}^\vee) = \langle\pi_A\alpha \tilde \pi_A(D)\rangle_\mathcal{O}.
    \]
\end{lemma}
\begin{proof}
    Let \(\phi \in \mathcal{O}^\vee = \hom_\mathcal{O}(\mathcal{O}, \mathcal{O})\).
    Then \(\phi(x) = x \cdot\phi(1) \in \mathcal{O}\). Therefore 
    \[
        \Psi(\pi_A^\vee(\phi)) = \Psi(\phi \circ \pi_A) = \alpha(\tilde{\phi} \circ \tilde{\pi_A}(D)) = \alpha(\phi(1)\cdot \tilde{\pi_A}(D)).
    \]
    Using the \(\mathcal{O}\)-linearity of \(\alpha\) and \(\pi_A\), we get
    \[
        \pi_A(\Psi(\pi_A^\vee(\phi))) = \phi(1) \cdot \pi_A \alpha \tilde{\pi_A}(D) \in \langle\pi_A\alpha \tilde \pi_A(D)\rangle_\mathcal{O}.
    \]
    For the other inclusion, let \(x\cdot \pi_A\alpha\tilde \pi_A \in \langle\pi_A\alpha \tilde \pi_A(D)\rangle_\mathcal{O}\) 
    with \(x \in \mathcal{O}\). Then define \(\phi(y) = y \cdot x \in \mathcal{O}^\vee\).
    By the calculations we have done so far it becomes clear that this is the required preimage.
\end{proof}

\begin{proposition}\cite[proposition 5.19]{darmon1995fermat}
    \[
        \eta_A = (\det(\partial f_i/\partial X_j(0))).
    \]
\end{proposition}
\begin{proof}
    We have \[
        \eta_A = \pi_A \Psi \pi_A^\vee(\mathcal{O}^\vee) = \pi_A\alpha \tilde \pi_A(D).
    \]
    Consider the equation
    \[
        (f_1, \dots, f_n) = (X_1 - [X_1], \dots, X_n - [X_n]) \cdot (m_{i,j})_{i,j}.
    \]
    Applying \(\tilde \pi_A\) to the whole equation leaves the \(f_i\) unchanged because \(\tilde \pi_A(X_i) = X_i\)
    and the coefficients of the \(f_i\) are elements of \(\mathcal{O}\) that are not affected by \(\pi_A\).
    On the RHS, we get \(\tilde \pi_A(X_i - [X_i]) = X_i - \pi_A([X_i]) = X_i\), as \(\pi_A\) 
    is the evaluation at \(0\) for preimages of \(A\) in \(\mathcal{O}[[X_1, \dots, X_n]]\).
    Denote the image of \(m_{i,j}\) under \(\tilde \pi_A\) with \(\tilde m_{i,j} \in \mathcal{O}[[X_1, \dots, X_n]]\).
    Now compute
    \[
        \frac{\partial f_i}{\partial X_j}(0) = \frac{\partial \sum_{k=1}^n X_k\tilde m_{k,i}}{\partial X_j}(0) 
        = \tilde m_{j,i}(0) + \sum_{k=1}^n X_k \frac{\partial \tilde m_{k,i}}{\partial X_j}\bigg|_{0} 
        = \tilde m_{j,i}(0).
    \]
    The composition \(\pi_A \circ \alpha\) is given by the evaluation at \(0\).
    Because computing the determinant is a linear operation, we get
    \[
        \pi_A \alpha \tilde \pi_A(D) = \det(\pi_A\alpha \tilde m_{i,j})_{i,j} = \det(\tilde m_{i,j}(0))_{i,j}
        = \det \frac{\partial f_i}{\partial X_j}(0).
    \]
\end{proof}

\begin{corollary}\cite[corollary 5.20]{darmon1995fermat}
    Remembering that we assumed \(A\) to be a finite flat complete intersection \(\in \cob\), we obtain
    \[
        \# \Phi_A = \# (\mathcal{O}/\eta_A),
    \]
    i.e. (c)\(\implies\)(b) in \cref{thm:wiles_numerical_criterion}.
\end{corollary}
\begin{proof}
    Should be true and mostly linear algebra, we will look up a reference.
\end{proof}

\section{Isomorphism theorems}

\begin{proposition}
    Let \(f\colon A \twoheadrightarrow B\) be a \(\cob\)-morphism and \(B\) a finite flat complete intersection.
    If the tangent spaces \(\phi_A, \phi_B\) are finite and 
    the induced morphism \(\tilde f\colon \phi_A \to \phi_B\) is an isomorphism,
    then \(f\) is an isomorphism.
\end{proposition}
\begin{proof}
    Consider the following commutative diagram
    \[
        \begin{tikzcd}
             & A \arrow[dd, "f", two heads] \arrow[rd, "\pi_A", two heads] 
             & \arrow[l, hook]\ker \pi_A \arrow[r, two heads]
             & \phi_A \arrow[dd, hook, two heads, "\tilde f"]\\
            U \arrow[ru, "\nu_A", two heads]\arrow[rd, "\nu_B"', two heads] & & \mathcal{O}&\\
             & B \arrow[ru, "\pi_B"', two heads] & \arrow[l, hook]\ker \pi_B \arrow[r, two heads] & \phi_B.
        \end{tikzcd}
    \]
    The projection \(\nu_B\) arises from the fact that we can write every object in \(\cob\)
    as a quotient of \(U\) (\cref{rem:quotientofU}).
    As \(B\) is a complete intersection, we find \(n\) generators \(f_i \in U\) s.t. \(\ker \nu_B = (f_1, \dots, f_n)\).
    Note that we need to choose the \(f_i\) in such a way that they have no constant term. 
    \textbf{Probably add general remark for this topic because its used several times.}
    Define \(b_i \coloneqq \nu_B(X_i) \in \ker \pi_B\) and choose preimages \(a_i \in A\) s.t. \(f(a_i) = b_i\).
    As the triangle involving \(A, B\) and \(\mathcal{O}\) commutes, we conclude that \(\pi_A(a_i) = \pi_B(b_i) = 0\),
    i.e. \(a_i \in \ker \pi_A\).
    
    As \(X_1, \dots, X_n\) generate \(\phi_U\) and \(\nu_B\) is surjective, it is easy to see that 
    \(b_1, \dots, b_n\) generate \(\phi_B\).
    We know that \(\tilde f\) is an isomorphism, so \(a_1, \dots, a_n\) generate \(\phi_A\).
    Define
    \[
        \nu_A \colon \mathcal{O}[[X_1, \dots, X_n]] \to A
    \] via \(\nu_A(X_i) = a_i\).
    As all generators lie in the image of \(\nu_A\), this induces a surjection on \(\phi_A\).
    By \cref{lem:surjectivity_phi} it follows that \(\phi\) is surjective.
    %kernel containments => well defined inverse => \phi is an iso
    
    Finally, we want to show that \(\ker \nu_A = \ker \nu_B\).
    Let \(x \in \ker \nu_A\), i.e. \(0 = f(0) = f(\nu_A(x)) = \nu_B(x)\), i.e. \(x \in \ker \nu_B\).
    Therefore it remains to prove the inclusion \(\ker \nu_B \subset \ker \nu_A\).
    
    The kernel of
    \[
        \overline{\nu_A} \colon \phi_U \to \phi_A  
    \]
    is a submodule of the finitely generated \(\mathcal{O}\)-module of rank \(n\) \(\phi_U\).
    As \(\mathcal{O}\) is a PID, we know that any submodule is finitely generated of rank \(n' \leq n\).
    Independent of \(n'\), we can choose \(n\) possibly linear dependent generators 
    \(\overline{g_1}, \dots \overline{g_n}\) of the above kernel and then extend these generators to 
    \(g_1, \dots, g_n \in \ker \nu_A\). A fortiori, the \(g_i\) do not have constant terms.

    As the kernel of \(\nu_B\) is generated by \(f_1, \dots, f_n\) and \(\ker \nu_A \subset \ker \nu_B\),
    we find a \(U\)-linear combination that can be written in the form
    \[
        (g_1, \dots, g_n) = (f_1, \dots, f_n) \cdot M,
    \]
    where \(M\) is a \(n \times n\) matrix with entries in \(U\).
    The \(g_i\) and the \(f_i\) both have no constant terms. Hence, forgetting all monomials 
    of degree bigger than one (equivalently considering the residue classes \(\mod\;\ker \pi_A^2\) 
    resp. \(\ker \pi_B^2\), denoted by \(\overline{\cdot}\)) forces us to take the constant terms \(\overline{M}\) of \(M\),
    \[
        (\overline{g_1}, \dots, \overline{g_n}) = (\overline{f_1}, \dots, \overline{f_n})\overline{M}.
    \]
    As the tangent spaces are isomorphic, both \((\overline{g_1}, \dots, \overline{g_n})\) and 
    \((\overline{f_1}, \dots, \overline{f_n})\) generate the same \(\mathcal{O}\)-submodule of
    \(\phi_U\).
    Indeed, 
    \(\overline{f_1}, \dots, \overline{f_n} = \ker( \ker \pi_U/\ker \pi_U^2 \to \ker \pi_B/\ker \pi_B^2)\).
    As a result, we can express each of the \(\overline{f_1}, \dots, \overline{f_n}\) as a 
    \(\mathcal{O}\)-linear combination of \((\overline{g_1}, \dots, \overline{g_n})\).
    This gives us an inverse to \(\overline{M}\) and we deduce that \(\det \overline{M}\) is invertible
    in \(\mathcal{O}\).
    A power series is invertible if its constant term is invertible so as a result \(\det M\) is invertible
    as well and we conclude that 
    \[ 
        f_1, \dots, f_n \in \langle g_1, \dots, g_n\rangle_U = \ker \nu_B
    \]
    and, a fortiori, 
    \[
        \ker \nu_A = \langle f_1, \dots, f_n\rangle_U \subset \ker \nu_B.
    \]
    
    In total we obtain \(\ker \nu_A = \ker \nu_B\) and we can define the map 
    \[
        \nu_A\nu_B^{-1}\colon B \to A.  
    \]
    This is indeed welldefined: For a given \(x \in B\) choose \(y, y' \in U\) s.t. 
    \(\nu_B(y) = \nu_B(y') = x\). It follows \(y' - y \in \ker \nu_B\). 
    Then \(\nu_A(y') = \nu_A(y'-y) + \nu_A(y) = 0 + \nu_A(y)\) because \(\ker \nu_A = \ker \nu_B\).
    From the commutativity of the above diagram we get that this is indeed an inverse for \(f\) and
    hence, \(f\) is an isomorphism.
\end{proof}

\section{A resolution lemma}

\begin{lemma}\label{lem:resolution}\cite[theorem 5.26]{darmon1995fermat}
    Let \(A \in \cob\) be finite flat. Then there is a \(\cob\)-morphism \(f\colon \tilde A \to A\) 
    where \(\tilde A\) is a finite flat complete intersection and \(f\) induces an isomorphism on the tangent spaces,
    \(\tilde f \colon \phi_{\tilde{A}} \xrightarrow{\sim} \phi_A\).
\end{lemma}
\begin{proof}
    First, we notice that \(\ker \pi_A\) is a finitely generated \(O\)-module.
    This follows from the fact that submodules of finitely generated modules over PIDs
    are finitely generated again.
    Let \(a_1, \dots, a_n\) be generators of \(\ker \pi_A\). Then define
    \[
        \phi\colon V \coloneqq \mathcal{O}[X_1, \dots, X_n] \to A  
    \]
    via \(\phi(X_i) = a_i\).
    We have seen in the proof of \cref{rem:quotientofU} that \(A = \ker \pi_A \oplus \mathcal{O}\).
    Defining \(\pi_V\) via \(X_i \mapsto 0\;\; \forall i\) we get \(V = \ker \pi_V \oplus \mathcal{O}\).
    \(\phi\) then induces an isomorphism on the second component, a surjection on the first
    and is therefore surjective.
    It is clear that
    \[
        \phi_V \coloneqq \ker \pi_V/(\ker \pi_V)^2 = \mathcal{O}X_1 \oplus \dots \oplus \mathcal{O}X_n
    \] 
    is a finitely generated \(\mathcal{O}\)-module of rank \(n\).
    Therefore the kernel of the projection \(\phi_V \to \phi_A\) is also finitely generated 
    of rank \(n' \leq n\).
    Independent of \(n'\), we can choose \(n\) possibly linearly dependent linear polynomials 
    \(\overline{f_i} \in \ker(\phi_V \to \phi_A)\) without constant term that generate 
    \(\ker \phi_V \to \phi_A\).
    Now consider a system \((f_1, \dots, f_n)\) of lifts to \(V\) and denote their maximal degree with \(m\).
    All elements of \(\ker \pi_A\) can be written as a linear combination of the generators \(a_i\), so a fortiori
    we find linear polynomials \(h_i(X_1, \dots, X_n)\) s.t. \(a_i^2 = h_i(a_1, \dots, a_n)\).
    With these additional relations we can replace the relations \(f_i\) by modified relations
    \[
        f_i + X_i^mh_i - X_i^{m+2}.  
    \]
    Now we see that \(V/(f_1, \dots, f_n)\) is a finitely generated \(\mathcal{O}\)-module, 
    because it is generated by the images of monomials of degree \(\leq n(m+1)\). Indeed, any monomial
    of higher degree must contain one of the \(X_i\) at least with potence \(m+2\). Then, using
    the relation \(f_i + X_i^mh_i - X_i^{m+2}\), it can be expressed as a sum of 
    monomials of lower degree.
    Therefore we get a surjection 
    \[
        \mathcal{O}[X_1, \dots, X_n]/(f_1, \dots, f_n) \to A.  
    \]
    The completion of the left side is still finitely generated (\textbf{Why?}) and therefore is
    a finitely generated module \(\in \cob\). From \cref{cor:flatness} we then
    conclude that its flat as well and therefore
    \[
        \tilde{A} \coloneqq \mathcal{O}[[X_1, \dots, X_n]]/(f_1, \dots, f_n)
    \]
    is a complete intersection where the tangent space is the completion of 
    \[
        \phi_{V/(f_1, \dots, f_n)} = \phi_V/(\overline{f_1}, \dots, \overline{f_n}).
    \]
    As \(\overline{f_1}, \dots, \overline{f_n}\) generate \(\ker \phi_V \to \phi_A\), they also generate 
    the completion \(\ker \phi_U \to \phi_A\) (\textbf{Why?}). Therefore, using \cref{rem:tangentspace}, 
    we have an isomorphism of the tangent spaces 
    \[
        \phi_{\tilde{A}} = \phi_U/(\overline{f_1}, \dots, \overline{f_n}) \to \phi_A,
    \]
    as desired.
\end{proof}

\section{A criterion for complete intersections}

\begin{proposition}\cite[theorem 5.27]{darmon1995fermat}\label{prop:criterionCI}
    Let \(A \in \cob\) be finite flat. If \(\# \phi_A \leq \#(\mathcal{O}/\eta_A) < \infty\), 
    then \(A\) is a complete intersection.
\end{proposition}
    
\begin{proof}
    Take the morphism \(\phi\colon \tilde{A} \to A\) from \cref{lem:resolution}.
    As \(\# \phi_A\) is finite, we can apply \cref{cor:surjectivity_phi} and because \(\phi\)
    induces an isomorphism on the tangent spaces, i.e. \(\# \phi_{\tilde{A}} = \#\phi_A\), it is surjective.
    By \cref{lem:standard_ineq} we also now that \(\#\phi_{\tilde{A}} \geq \#(\mathcal{O}/\eta_{\tilde{A}})\).
    Starting with the assumption and then using both of the previous facts, we obtain
    \[
        \#(\mathcal{O}/\eta_A) \geq \#\phi_A = \#\phi_{\tilde{A}} \geq \#(\mathcal{O}/\eta_{\tilde{A}}).
    \]
    As \(\tilde{A} \twoheadrightarrow A\) is surjective, we apply \cref{lem:surjectivity_eta} 
    and deduce 
    \[
        \eta_{\tilde{A}} \subset \eta_A, \;\; \#(\mathcal{O}/\eta_{\tilde{A}}) \geq \#(\mathcal{O}/\eta_A).
    \]
    All in all, we have \(\#(\mathcal{O}/\eta_A) = \#(\mathcal{O}/\eta_{\tilde{A}})\) and because of
    \(\eta_{\tilde{A}} \subset \eta_A\) we conclude \(\eta_{\tilde{A}} = \eta_A\).
    By \textbf{add reference here} it follows that \(\phi\) is an isomorphism.
    Since \(\tilde{A}\) is a complete intersection, so is \(A\).
\end{proof}

\section{Proof of Wiles' numerical criterion}

\begin{proposition}
    Let \(R, T \in \cob\) such that \(T\) is finite flat and 
    \(\phi\colon R \twoheadrightarrow T\) is a surjective \(\cob\)-morphism.
    If \(\# \phi_R \leq \#(\mathcal{O}/\eta_T) < \infty\), then \(R\) and \(T\) are complete intersections,
    and \(\phi\) is an isomorphism.
\end{proposition}
\begin{proof}
    Concatenating the inequalities from \cref{lem:standard_ineq}, 
    \cref{cor:surjectivity_phi} which is applicable because of the surjectivity of \(\phi\)
    and from the assumption, we obtain
    \[
        \#(\mathcal{O}/\eta_T) \leq \#\phi_T \leq \#\phi_R \leq \#(\mathcal{O}/\eta_T).
    \]
    All inequalities must be equalities and from \(\#\phi_T = \#(\mathcal{O}/\eta_T)\)
    we conclude with \cref{prop:criterionCI} that \(T\) is a complete intersection.
    From \(\#\phi_T = \#\phi_R \) we see that \(\phi\) induces an isomorphism on the tangent spaces.
    From \textbf{add reference here} it follows that \(\phi\colon R \to T\) is an isomorphism and, 
    a fortiori \(R\) is a complete intersection as well.
\end{proof}

\newpage
\printbibliography

\end{document}